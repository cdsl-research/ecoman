{% include "_header.html" %}

<main>
  <section>
    <fieldset>
      <a href="https://{{ machine.esxi_node_address }}/ui/#/host/vms/{{ machine.id }}">
        <button class="btn btn-primary">ESXi Console</button>
      </a>
    </fieldset>
    <fieldset>
      <div class="btn-group btn-group-block">
        <button class="btn btn-success">Power ON</button>
        <button class="btn btn-error">Shutdown</button>
        <button class="btn">Suspend</button>
        <button class="btn">Reboot</button>
      </div>
    </fieldset>
  </section>

  <section>
    <h3>Machine Overview</h3>

    <table class="table">
      <tr>
        <td>VM Name</td>
        <td><b>{{ machine.name }}</b></td>
      </tr>
      <tr>
        <td>Power Status</td>
        <td>{{ machine.power | upper }}</td>
      </tr>
      <tr>
        <td>IP Address</td>
        <td>
          {{ machine.ip_address }} <br>

          <details>
            <summary>SSH Command</summary>
            <code>ssh USERNAME@{{ machine.ip_address }}</code>
          </details>
        </td>
      </tr>
      <tr>
        <td>ESXi Node</td>
        <td>{{ machine.esxi_node_name }} ({{ machine.esxi_node_address }})</td>
      </tr>

      <tr>
        <td>VMware Tools Status</td>
        <td>{{ machine.tools_status }}</td>
      </tr>
      <tr>
        <td>VM Health Status</td>
        <td>{{ machine.overall_status }}</td>
      </tr>
      <tr>
        <td>BootTime</td>
        <td>{{ machine.boot_time }}</td>
      </tr>
      <tr>
        <td>Uptime</td>
        <td>
          {% if machine.uptime_seconds is none %}
          -
          {% else %}
          {{ machine.uptime_seconds // 86400 }}d
          {{ machine.uptime_seconds % 86400 // 3600}}h
          {{ machine.uptime_seconds % 86400 % 3600 // 60 }}m
          {% endif %}
        </td>
      </tr>
    </table>
  </section>

  <section>
    <h3>Hardware Spec</h3>

    <table class="table">
      <tr>
        <td>CPU</td>
        <td>{{ machine.num_cpu }} [Core]</td>
      </tr>
      <tr>
        <td>RAM</td>
        <td>{{ machine.memory_size_mb // 1000 }} [GB]</td>
      </tr>
      <tr>
        <td>Storage</td>
        <td>{{ machine.storage_commited // (1000 ** 3) }} [GB]</td>
      </tr>
      <tr>
        <td>Num of Ethernet Cards</td>
        <td>{{ machine.num_ethernet_cards }}</td>
      </tr>
      <tr>
        <td>Num of Virtual Disks</td>
        <td>{{ machine.num_virtual_disks }}</td>
      </tr>
      <tr>
        <td>Guest OS Fullname</td>
        <td>{{ machine.guest_fullname }}</td>
      </tr>
      <tr>
        <td>Datastore</td>
        <td>{{ machine.datastore }}</td>
      </tr>
      <tr>
        <td>Datastore Path</td>
        <td>{{ machine.datastore_path }}</td>
      </tr>
    </table>
  </section>

  <section>
    <h3>Hardware Metrics</h3>
    <table class="table">
      <tr>
        <td>RAM Usage</td>
        <td>{{ machine.guest_memory_usage / machine.memory_size_mb * 100 // 1 }} [%]</td>
      </tr>
      <tr>
        <td>CPU Usage</td>
        <td>{{ machine.overall_cpu_usage / machine.num_cpu // 1 }} [%]</td>
      </tr>
    </table>
  </section>

</main>

<style>
  main fieldset {
    margin: 0 2rem 0 0;
    display: inline-block;
  }

  main section {
    margin: 2em 0;
  }

  main table th,
  main table td {
    vertical-align: top;
  }

  main .table {
    max-width: 600px;
  }
</style>

<script>
  let setPower = function () {
    const url = '/v1/machine/{{ uniq_id }}/power';
    const powerState = document.getElementById('power_state').value;
    const payload = { 'state': powerState };

    fetch(url, {
      method: 'PUT',
      body: JSON.stringify(payload), // data can be `string` or {object}!
      headers: {
        'Content-Type': 'application/json'
      }
    }).then(res => res.json())
      .then(response => {
        console.log('Success:', JSON.stringify(response));
        document.getElementById('message').innerHTML = 'Success: ' + response['detail'];
        document.getElementById('current_power').innerHTML = powerState.toUpperCase();
      })
      .catch(error => {
        console.error('Error:', error)
        document.getElementById('message').innerHTML = error;
      });
  }

  let commitButton = document.getElementById('commit');
  commitButton.addEventListener("click", setPower, false);
</script>
{% include "_footer.html" %}